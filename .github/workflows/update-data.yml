    - name: Collect backup data
      run: |
        mkdir -p data
        echo "{" > data/data.json
        echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> data/data.json
        
        # Calcular timestamp de 7 dias atrÃ¡s
        seven_days_ago=$(date -u -d "7 days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || echo "2026-02-19T00:00:00Z")
        
        for env in DEV HOM PROD; do
          case $env in
            DEV) cluster="aks-core-dev"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062"; rg="rg-core-capabilities-aks-dev"; storage="aksbackupdev52857" ;;
            HOM) cluster="aks-core-hom"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062"; rg="rg-core-capabilities-aks-hom"; storage="aksbackuphom19041" ;;
            PROD) cluster="aks-core-prod"; sub="6c737912-b263-4f31-86a4-8f93c351fcac"; rg="rg-core-capabilities-aks-prod"; storage="aksbackupprod25668" ;;
          esac
          
          echo "=== Processing $env ==="
          
          # Conectar ao cluster
          if az aks get-credentials --name $cluster --resource-group $rg --subscription $sub --overwrite-existing; then
            echo "âœ… Connected to cluster $cluster"
            
            # Buscar backups usando kubectl
            kubectl_output=$(kubectl get backups.velero.io -n velero -o json 2>&1)
            
            if echo "$kubectl_output" | jq -e '.items' >/dev/null 2>&1; then
              backups=$(echo "$kubectl_output" | jq -c --arg cutoff "$seven_days_ago" '
                [.items[] | select(.metadata.creationTimestamp >= $cutoff) | 
                { 
                  name: .metadata.name, 
                  status: (.status.phase // "Unknown"), 
                  created: .metadata.creationTimestamp, 
                  namespaces: (.spec.includedNamespaces // ["*"])
                }]
              ' 2>/dev/null || echo '[]')
              
              if [ -z "$backups" ] || [ "$backups" = "null" ] || ! echo "$backups" | jq -e '.' >/dev/null 2>&1; then
                backups='[]'
              fi
              
              backup_count=$(echo "$backups" | jq 'length' 2>/dev/null || echo "0")
              echo "âœ… Found $backup_count backups"
            else
              echo "âš ï¸ No valid backups found"
              backups='[]'
            fi
          else
            echo "âŒ Could not connect to cluster"
            backups='[]'
          fi
          
          # Buscar storage usage - MÃ‰TODO CORRIGIDO
          echo "ğŸ’¾ Fetching storage data for $storage..."
          
          # MÃ©todo 1: Tentar Azure CLI com storage account
          blob_count=$(az storage blob list \
            --account-name $storage \
            --container-name velero \
            --query "length(@)" \
            -o tsv 2>/dev/null || echo "0")
          
          # Se nÃ£o funcionar, tentar container velero-backups
          if [ "$blob_count" = "0" ] || [ -z "$blob_count" ]; then
            blob_count=$(az storage blob list \
              --account-name $storage \
              --container-name velero-backups \
              --query "length(@)" \
              -o tsv 2>/dev/null || echo "0")
          fi
          
          # Calcular tamanho total em GB
          if [ "$blob_count" != "0" ] && [ -n "$blob_count" ]; then
            # Pegar tamanhos dos blobs
            total_bytes=$(az storage blob list \
              --account-name $storage \
              --container-name velero \
              --query "[].properties.contentLength" \
              -o json 2>/dev/null | jq '[.[] | select(. != null)] | add // 0' 2>/dev/null || echo "0")
            
            if [ "$total_bytes" = "null" ] || [ -z "$total_bytes" ]; then
              total_bytes=0
            fi
            
            # Converter para GB (bytes / 1024^3)
            storage_gb=$(echo "scale=2; $total_bytes / 1073741824" | bc 2>/dev/null || echo "0")
            
            # Se der 0, usar estimativa baseada no nÃºmero de blobs (1MB por blob)
            if [ "$storage_gb" = "0" ] || [ -z "$storage_gb" ]; then
              storage_gb=$(echo "scale=2; $blob_count * 0.001" | bc 2>/dev/null || echo "0")
            fi
          else
            storage_gb=0
          fi
          
          echo "ğŸ“Š Blobs: $blob_count, Storage: ${storage_gb} GB"
          
          # Escrever no JSON
          comma=""
          [ "$env" != "PROD" ] && comma=","
          echo "  \"$env\": {\"backups\": $backups, \"storage_gb\": $storage_gb}$comma" >> data/data.json
          
          echo "âœ… Completed $env"
        done
        
        echo "}" >> data/data.json
        
        echo "=== Final data.json ==="
        cat data/data.json
        echo "======================="
        
        # Validar JSON
        if jq -e '.' data/data.json >/dev/null 2>&1; then
          echo "âœ… data.json is valid"
        else
          echo "âŒ Invalid JSON!"
          exit 1
        fi