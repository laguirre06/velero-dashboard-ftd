name: Update Velero Backup Data

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Install Velero CLI
      run: |
        wget -q -O velero.tar.gz https://github.com/vmware-tanzu/velero/releases/download/v1.17.2/velero-v1.17.2-linux-amd64.tar.gz
        tar -xzf velero.tar.gz
        sudo mv velero-v1.17.2-linux-amd64/velero /usr/local/bin/
        rm -rf velero.tar.gz velero-v1.17.2-linux-amd64

    - name: Collect backup data
      run: |
        mkdir -p data
        echo "{" > data/data.json
        echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> data/data.json
        
        for env in DEV HOM PROD; do
          case $env in
            DEV) cluster="aks-core-dev"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062"; storage="aksbackupdev52857" ;;
            HOM) cluster="aks-core-hom"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062"; storage="aksbackuphom19041" ;;
            PROD) cluster="aks-core-prod"; sub="6c737912-b263-4f31-86a4-8f93c351fcac"; storage="aksbackupprod25668" ;;
          esac
          
          echo "Processing $env ($cluster)..."
          
          # Conectar ao cluster
          if ! az aks get-credentials --name $cluster --subscription $sub --overwrite-existing; then
            echo "Warning: Could not connect to cluster $cluster"
          fi
          
          # Buscar backups do Velero
          echo "Fetching Velero backups..."
          if velero_output=$(velero backup get -o json --since 168h 2>&1); then
            echo "Velero output received"
            # Processar com jq
            backups=$(echo "$velero_output" | jq -c '[.items[] | { name: .metadata.name, status: (.status.phase // "Unknown"), created: .metadata.creationTimestamp, namespaces: (.spec.includedNamespaces // ["*"])}]' 2>/dev/null || echo '[]')
          else
            echo "Warning: Velero command failed or no backups found"
            backups='[]'
          fi
          
          # Garantir que backups seja um array vÃ¡lido
          if [ -z "$backups" ] || [ "$backups" = "null" ]; then
            backups='[]'
          fi
          
          # Buscar storage usage
          echo "Fetching storage data..."
          blob_count=$(az storage blob list --account-name $storage --container-name velero-backups --query "length(@)" -o tsv 2>/dev/null || echo "0")
          if [ -z "$blob_count" ] || [ "$blob_count" = "null" ]; then
            blob_count=0
          fi
          storage_gb=$(echo "scale=1; $blob_count * 0.001" | bc 2>/dev/null || echo "0")
          
          echo "Backups: $backups, Storage: ${storage_gb} GB"
          
          comma=""
          [ "$env" != "PROD" ] && comma=","
          echo "  \"$env\": {\"backups\": $backups, \"storage_gb\": $storage_gb}$comma" >> data/data.json
        done
        
        echo "}" >> data/data.json
        
        echo "Final data.json:"
        cat data/data.json

    - name: Commit and push if changed
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add data/data.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update: $(date -u +%Y-%m-%dT%H:%M:%SZ)" && git push)
