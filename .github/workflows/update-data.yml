name: Update Velero Backup Data

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Install Velero CLI
      run: |
        wget -q -O velero.tar.gz https://github.com/vmware-tanzu/velero/releases/download/v1.17.2/velero-v1.17.2-linux-amd64.tar.gz
        tar -xzf velero.tar.gz
        sudo mv velero-v1.17.2-linux-amd64/velero /usr/local/bin/
        rm -rf velero.tar.gz velero-v1.17.2-linux-amd64

    - name: Collect backup data
      run: |
        mkdir -p data
        echo "{" > data/data.json
        echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> data/data.json
        
        seven_days_ago=$(date -u -d "7 days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || echo "2026-02-19T00:00:00Z")
        
        for env in DEV HOM PROD; do
          case $env in
            DEV) cluster="aks-core-dev"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062"; rg="rg-core-capabilities-aks-dev"; storage="aksbackupdev52857" ;;
            HOM) cluster="aks-core-hom"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062"; rg="rg-core-capabilities-aks-hom"; storage="aksbackuphom19041" ;;
            PROD) cluster="aks-core-prod"; sub="6c737912-b263-4f31-86a4-8f93c351fcac"; rg="rg-core-capabilities-aks-prod"; storage="aksbackupprod25668" ;;
          esac
          
          echo "=== Processing $env ==="
          
          if az aks get-credentials --name $cluster --resource-group $rg --subscription $sub --overwrite-existing; then
            echo "‚úÖ Connected to cluster $cluster"
            
            kubectl_output=$(kubectl get backups.velero.io -n velero -o json 2>&1)
            
            if echo "$kubectl_output" | jq -e '.items' >/dev/null 2>&1; then
              backups=$(echo "$kubectl_output" | jq -c --arg cutoff "$seven_days_ago" '[.items[] | select(.metadata.creationTimestamp >= $cutoff) | { name: .metadata.name, status: (.status.phase // "Unknown"), created: .metadata.creationTimestamp, namespaces: (.spec.includedNamespaces // ["*"])}]' 2>/dev/null || echo '[]')
              
              if [ -z "$backups" ] || [ "$backups" = "null" ]; then
                backups='[]'
              fi
              
              backup_count=$(echo "$backups" | jq 'length' 2>/dev/null || echo "0")
              echo "‚úÖ Found $backup_count backups"
            else
              echo "‚ö†Ô∏è No valid backups found"
              backups='[]'
            fi
          else
            echo "‚ùå Could not connect to cluster"
            backups='[]'
          fi
          
          echo "üíæ Fetching storage data for $storage..."
          blob_count=$(az storage blob list --account-name $storage --container-name velero --query "length(@)" -o tsv 2>/dev/null || echo "0")
          
          if [ "$blob_count" = "0" ] || [ -z "$blob_count" ]; then
            blob_count=$(az storage blob list --account-name $storage --container-name velero-backups --query "length(@)" -o tsv 2>/dev/null || echo "0")
          fi
          
          if [ "$blob_count" != "0" ] && [ -n "$blob_count" ]; then
            total_bytes=$(az storage blob list --account-name $storage --container-name velero --query "[].properties.contentLength" -o json 2>/dev/null | jq '[.[] | select(. != null)] | add // 0' 2>/dev/null || echo "0")
            
            if [ "$total_bytes" = "null" ] || [ -z "$total_bytes" ]; then
              total_bytes=0
            fi
            
            storage_gb=$(echo "scale=2; $total_bytes / 1073741824" | bc 2>/dev/null || echo "0")
            
            if [ "$storage_gb" = "0" ] || [ -z "$storage_gb" ]; then
              storage_gb=$(echo "scale=2; $blob_count * 0.001" | bc 2>/dev/null || echo "0")
            fi
          else
            storage_gb=0
          fi
          
          echo "üìä Blobs: $blob_count, Storage: ${storage_gb} GB"
          
          comma=""
          [ "$env" != "PROD" ] && comma=","
          echo "  \"$env\": {\"backups\": $backups, \"storage_gb\": $storage_gb}$comma" >> data/data.json
          
          echo "‚úÖ Completed $env"
        done
        
        echo "}" >> data/data.json
        
        echo "=== Final data.json ==="
        cat data/data.json
        echo "======================="
        
        if jq -e '.' data/data.json >/dev/null 2>&1; then
          echo "‚úÖ data.json is valid"
        else
          echo "‚ùå Invalid JSON!"
          exit 1
        fi

    - name: Commit and push if changed
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add data/data.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update: $(date -u +%Y-%m-%dT%H:%M:%SZ)" && git push)