name: Delete Velero Backup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente (DEV/HOM/PROD)'
        required: true
        default: 'DEV'
        type: choice
        options:
        - DEV
        - HOM
        - PROD
      backup_name:
        description: 'Nome exato do backup para deletar'
        required: true

permissions:
  contents: write
  actions: write

jobs:
  delete-backup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Get cluster credentials
      run: |
        env="${{ github.event.inputs.environment }}"
        case $env in
          DEV) cluster="aks-core-dev"; rg="rg-core-capabilities-aks-dev"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062" ;;
          HOM) cluster="aks-core-hom"; rg="rg-core-capabilities-aks-hom"; sub="57fb5e7c-3a3c-459f-857d-3914d34e6062" ;;
          PROD) cluster="aks-core-prod"; rg="rg-core-capabilities-aks-prod"; sub="6c737912-b263-4f31-86a4-8f93c351fcac" ;;
        esac
        
        az aks get-credentials --name $cluster --resource-group $rg --subscription $sub --overwrite-existing

    - name: Delete backup
      run: |
        backup_name="${{ github.event.inputs.backup_name }}"
        
        echo "⚠️ Deleting backup: $backup_name"
        velero backup delete $backup_name --confirm
        
        echo "✅ Backup $backup_name deleted successfully!"

    - name: Update data.json
      run: |
        # Re-executar workflow de atualização
        gh workflow run update-data.yml
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}